#!/usr/bin/env bash
set -euo pipefail

WALL_DIR="$HOME/wallpapers"
STATE_FILE="$HOME/.config/hypr/.wallpaper-current"
TRANSITION_TYPE="fade"
TRANSITION_DURATION="0.18"
TRANSITION_FPS="75"

usage() {
    cat <<'EOF'
usage: wallpaperctl <command> [args]

commands:
    list                 list wallpaper files from ~/wallpapers
    apply <path>         apply wallpaper with fade transition and persist state
    restore              restore wallpaper from state file (no transition)
    current              print current persisted wallpaper path
EOF
}

ensure_swww() {
    command -v swww >/dev/null 2>&1 || return 1
    if ! pgrep -x swww-daemon >/dev/null 2>&1; then
        nohup swww-daemon --format xrgb >/dev/null 2>&1 &
        sleep 0.15
    fi
}

list_wallpapers() {
    if [[ ! -d "$WALL_DIR" ]]; then
        return 0
    fi

    fd -a -d 1 -t f -e png -e jpg -e jpeg -e webp -e bmp . "$WALL_DIR" | sort
}

apply_wallpaper() {
    local wall="${1:-}"
    local current=""
    [[ -n "$wall" && -f "$wall" ]] || return 1

    if [[ -s "$STATE_FILE" ]]; then
        current="$(<"$STATE_FILE")"
        if [[ "$current" == "$wall" ]]; then
            return 0
        fi
    fi

    ensure_swww || return 1

    swww img "$wall" \
        --resize crop \
        --transition-type "$TRANSITION_TYPE" \
        --transition-duration "$TRANSITION_DURATION" \
        --transition-fps "$TRANSITION_FPS" \
        >/dev/null 2>&1

    mkdir -p "$(dirname "$STATE_FILE")"
    printf '%s\n' "$wall" > "$STATE_FILE"
}

restore_wallpaper() {
    local wall=""
    [[ -s "$STATE_FILE" ]] || return 0
    wall="$(<"$STATE_FILE")"
    [[ -n "$wall" && -f "$wall" ]] || return 0

    ensure_swww || return 1
    swww img "$wall" --resize crop --transition-type none >/dev/null 2>&1 || true
}

case "${1:-}" in
    list)
        list_wallpapers
        ;;
    apply)
        apply_wallpaper "${2:-}"
        ;;
    restore)
        restore_wallpaper
        ;;
    current)
        [[ -s "$STATE_FILE" ]] && cat "$STATE_FILE" || true
        ;;
    *)
        usage
        exit 1
        ;;
esac
